<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
  <title>授权码验证系统</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, Segoe UI, sans-serif; }
    body { background: #f3f3f3; padding: 30px 20px; max-width: 500px; margin: 0 auto; }
    .verify-box { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: relative; }
    #logoutBtn { position: absolute; top: 15px; right: 15px; background: #e9ecef; color: #495057; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer; transition: background 0.2s; display: block !important; }
    #logoutBtn:hover { background: #dee2e6; }
    h2 { text-align: center; color: #333; margin-bottom: 20px; font-size: 20px; }
    #codeInput { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; margin-bottom: 15px; text-transform: uppercase; display: none; }
    #enterBtn { width: 100%; background: #7d2ae8; color: #fff; border: none; padding: 12px; border-radius: 6px; font-size: 16px; cursor: pointer; transition: background 0.2s; display: block !important; }
    #enterBtn:hover { background: #6b23c2; }
    #result { margin-top: 18px; padding: 12px; border-radius: 6px; font-size: 15px; text-align: center; white-space: pre-line; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.6); color: #fff; padding: 10px 20px; border-radius: 6px; font-size: 15px; display: none; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
  <div class="verify-box">
    <button id="logoutBtn">退出授权码</button>
    <h2>授权码验证</h2>
    <input type="text" id="codeInput" placeholder="请输入16位授权码（不区分大小写）" maxlength="16">
    <button id="enterBtn">进入</button>
    <div id="result"></div>
  </div>
  <div id="loading">验证中...</div>
  <script>
    // Firebase初始化
    firebase.initializeApp({
      apiKey: "AIzaSyBd88UKHBOUpyHCtMXt1vliPN_F_9-Eh-0",
      databaseURL: "https://card-verify-system-default-rtdb.asia-southeast1.firebasedatabase.app"
    });
    const db = firebase.database();
    const STORAGE_KEY = "savedAuthCode";
    const QUERY_TIMEOUT = 10000;
    const codeInput = document.getElementById("codeInput");
    const enterBtn = document.getElementById("enterBtn");
    const resultEl = document.getElementById("result");
    const loadingEl = document.getElementById("loading");
    const logoutBtn = document.getElementById("logoutBtn");
    let currentTargetUrl = null;
    const targetUrlRef = db.ref("config/targetUrl");

    // -------------------------- 核心：加密脚本链接（Base64解码） --------------------------
    // 1. 解码函数：把加密的Base64字符串转成真实链接
    function decodeUrl(encodedStr) {
      try {
        // Base64解码（兼容特殊字符）
        return decodeURIComponent(atob(encodedStr).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
      } catch (err) {
        console.error("链接解码失败，使用默认链接", err);
        // 默认链接也加密（这里是你原默认链接的Base64编码，真实地址：http://webhost.snkj.xyz/users/2673976185/tong-script.html）
        return decodeURIComponent(atob("aHR0cDovL3dlYmhvc3Quc25rai54eXovdXNlcnMvMjY3Mzk3NjE4NS90b25nLXNjcmlwdC5odG1s").split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
      }
    }

    // 2. 实时监听数据库链接，拿到后自动解码（源码中看不到真实链接）
    targetUrlRef.on("value", function(snapshot) {
      const encodedUrl = snapshot.val();
      if (encodedUrl) {
        // 数据库存加密后的Base64链接，这里解码成真实地址
        currentTargetUrl = decodeUrl(encodedUrl);
      } else {
        // 数据库无链接时，用解码后的默认链接
        currentTargetUrl = decodeUrl("aHR0cDovL3dlYmhvc3Quc25rai54eXovdXNlcnMvMjY3Mzk3NjE4NS90b25nLXNjcmlwdC5odG1s");
      }
    });
    // -------------------------- 链接加密逻辑结束 --------------------------

    // 检查本地存储的授权码
    function checkSavedAuthCode() {
      return new Promise(function(resolve) {
        try {
          const savedData = localStorage.getItem(STORAGE_KEY);
          if (!savedData) return resolve(null);
          const data = JSON.parse(savedData);
          if (data.durationType === "permanent") {
            return resolve({ code: data.code.toUpperCase(), valid: true });
          }
          const now = Date.now();
          const expireTimestamp = new Date(data.expireTime).getTime();
          if (expireTimestamp > now) {
            return resolve({ code: data.code.toUpperCase(), valid: true });
          }
          localStorage.removeItem(STORAGE_KEY);
          resolve(null);
        } catch (err) {
          console.warn("本地存储读取失败：", err);
          resolve(null);
        }
      });
    }

    // 保存授权码到本地
    function saveAuthCodeToStorage(authData) {
      try {
        const saveData = {
          code: authData.code.toUpperCase(),
          expireTime: authData.expireTime,
          durationType: authData.durationType
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));
      } catch (err) {
        console.warn("本地存储写入失败：", err);
      }
    }

    // 计算到期时间
    function calculateExpireTime(durationType) {
      const now = new Date();
      if (durationType === "day") now.setDate(now.getDate() + 1);
      else if (durationType === "week") now.setDate(now.getDate() + 7);
      else if (durationType === "month") now.setMonth(now.getMonth() + 1);
      else if (durationType === "permanent") return "永久卡";
      return now.toLocaleString("zh-CN", { year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" });
    }

    // 更新授权码状态
    function updateAuthStatus(code, authData) {
      const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("状态更新超时")), QUERY_TIMEOUT));
      return new Promise(resolve => {
        try {
          if (!authData.id) return resolve({ success: false, errMsg: "未获取到授权码主ID" });
          const nowTime = new Date().toLocaleString("zh-CN", { year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit", second: "2-digit" });
          const isPermanent = authData.durationType === "permanent";
          const expireTime = isPermanent ? "永久卡" : calculateExpireTime(authData.durationType);
          const writableAuthData = JSON.parse(JSON.stringify(authData));
          if (!writableAuthData.isUsed) {
            writableAuthData.firstUseTime = nowTime;
            writableAuthData.isUsed = true;
            writableAuthData.status = "已使用";
          }
          writableAuthData.expireTime = expireTime;
          Promise.race([
            Promise.all([db.ref(`authCodesByCode/${code}`).update(writableAuthData), db.ref(`authCodes/${authData.id}`).update(writableAuthData)]),
            timeoutPromise
          ]).then(() => resolve({ success: true, authData: writableAuthData }))
            .catch(err => { console.error("状态更新失败：", err); resolve({ success: false, errMsg: err.message }); });
        } catch (err) {
          console.error("状态更新失败：", err);
          resolve({ success: false, errMsg: err.message });
        }
      });
    }

    // 切换输入框显示
    function toggleCodeInput(show) {
      codeInput.style.display = show ? "block" : "none";
    }

    // 退出授权码
    function logoutAuthCode() {
      try { localStorage.removeItem(STORAGE_KEY); }
      catch (err) { console.warn("本地存储删除失败：", err); }
      codeInput.value = "";
      resultEl.className = "";
      resultEl.textContent = "";
      toggleCodeInput(true);
      alert("已退出授权码，下次需重新输入");
    }

    // 进入按钮点击逻辑
    async function handleEnterClick() {
      if (!currentTargetUrl) {
        resultEl.className = "error";
        resultEl.textContent = "目标脚本链接未配置，请稍后再试";
        return;
      }
      const savedAuth = await checkSavedAuthCode();
      if (savedAuth) {
        window.location.href = currentTargetUrl;
        return;
      }
      const inputCode = codeInput.value.trim().toUpperCase();
      if (inputCode.length !== 16) {
        resultEl.className = "error";
        resultEl.textContent = "请输入16位授权码后进入！";
        codeInput.focus();
        return;
      }
      loadingEl.style.display = "block";
      resultEl.className = "";
      resultEl.textContent = "";
      try {
        const codeRef = db.ref(`authCodesByCode/${inputCode}`);
        const codeSnapshot = await Promise.race([codeRef.once("value"), new Promise((_, reject) => setTimeout(() => reject(new Error("验证超时")), QUERY_TIMEOUT))]);
        if (!codeSnapshot.exists()) throw new Error("授权码不存在");
        let authData = JSON.parse(JSON.stringify(codeSnapshot.val()));
        if (!authData.id) {
          const mainRef = db.ref("authCodes").orderByChild("code").equalTo(inputCode);
          const mainSnapshot = await Promise.race([mainRef.once("value"), new Promise((_, reject) => setTimeout(() => reject(new Error("主节点查询超时")), QUERY_TIMEOUT))]);
          const mainData = mainSnapshot.val();
          if (!mainData) throw new Error("主节点未找到该授权码");
          const mainKeys = Object.keys(mainData);
          if (mainKeys.length === 0) throw new Error("主节点未找到该授权码");
          authData.id = mainKeys[0];
        }
        if (authData.durationType !== "permanent") {
          const expireTimestamp = new Date(authData.expireTime || "").getTime();
          const now = Date.now();
          if (expireTimestamp && expireTimestamp < now) throw new Error("授权码已过期");
        }
        const updateRes = await updateAuthStatus(inputCode, authData);
        if (!updateRes.success) throw new Error(`状态同步失败：${updateRes.errMsg}`);
        authData = updateRes.authData;
        saveAuthCodeToStorage(authData);
        resultEl.className = "success";
        resultEl.textContent = `验证成功！即将进入脚本...`;
        setTimeout(() => window.location.href = currentTargetUrl, 300);
      } catch (err) {
        loadingEl.style.display = "none";
        resultEl.className = "error";
        resultEl.textContent = `验证失败：${err.message || "网络异常"}`;
      } finally {
        loadingEl.style.display = "none";
      }
    }

    // 绑定事件
    window.addEventListener("DOMContentLoaded", async function() {
      const savedAuth = await checkSavedAuthCode();
      toggleCodeInput(!savedAuth);
      enterBtn.onclick = handleEnterClick;
      logoutBtn.onclick = logoutAuthCode;
      codeInput.onkeydown = e => e.key === "Enter" && handleEnterClick();
    });
  </script>
</body>
</html>